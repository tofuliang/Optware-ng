From 0f1c21f3369cc722107fb18ad6cbfa15793c0f8e Mon Sep 17 00:00:00 2001
From: Martin Pitt <mpitt@debian.org>
Date: Tue, 9 Aug 2016 18:11:32 +0200
Subject: Add support for creating pid files in /run

Bug: http://www.cups.org/str.php?L2465

Last-Update: 2015-02-10

Patch-Name: pidfile.patch
---
 scheduler/conf.c      |  5 ++++-
 scheduler/conf.h      |  2 ++
 scheduler/main.c      | 38 ++++++++++++++++++++++++++++++++++++++
 test/run-stp-tests.sh |  1 +
 4 files changed, 45 insertions(+), 1 deletion(-)

diff --git a/scheduler/conf.c b/scheduler/conf.c
index 0e06044a7..ea6d22372 100644
--- a/scheduler/conf.c
+++ b/scheduler/conf.c
@@ -163,7 +163,8 @@ static const cupsd_var_t	cupsfiles_vars[] =
 #ifdef HAVE_AUTHORIZATION_H
   { "SystemGroupAuthKey",	&SystemGroupAuthKey,	CUPSD_VARTYPE_STRING },
 #endif /* HAVE_AUTHORIZATION_H */
-  { "TempDir",			&TempDir,		CUPSD_VARTYPE_PATHNAME }
+  { "TempDir",			&TempDir,		CUPSD_VARTYPE_PATHNAME },
+  { "PidFile",			&PidFile,		CUPSD_VARTYPE_STRING }
 };
 
 static int		default_auth_type = CUPSD_AUTH_AUTO;
@@ -592,6 +593,7 @@ cupsdReadConfiguration(void)
   cupsdSetStringf(&ServerHeader, "CUPS/%d.%d IPP/2.1", CUPS_VERSION_MAJOR,
                   CUPS_VERSION_MINOR);
   cupsdSetString(&StateDir, CUPS_STATEDIR);
+  cupsdSetString(&PidFile, "/run/cups/cupsd.pid");
 
   if (!strcmp(CUPS_DEFAULT_PRINTCAP, "/etc/printers.conf"))
     PrintcapFormat = PRINTCAP_SOLARIS;
@@ -3431,6 +3433,7 @@ read_cupsd_conf(cups_file_t *fp)	/* I - File to read from */
              !_cups_strcasecmp(line, "SystemGroup") ||
              !_cups_strcasecmp(line, "SystemGroupAuthKey") ||
              !_cups_strcasecmp(line, "TempDir") ||
+             !_cups_strcasecmp(line, "PidFile") ||
 	     !_cups_strcasecmp(line, "User"))
     {
       cupsdLogMessage(CUPSD_LOG_INFO,
diff --git a/scheduler/conf.h b/scheduler/conf.h
index 873c370e6..66e4f68a6 100644
--- a/scheduler/conf.h
+++ b/scheduler/conf.h
@@ -245,6 +245,8 @@ VAR int			CreateSelfSignedCerts	VALUE(TRUE);
 VAR char		*ServerKeychain		VALUE(NULL);
 					/* Keychain holding cert + key */
 #endif /* HAVE_SSL */
+VAR char		*PidFile		VALUE(NULL);
+					/* Debian CUPS pid file */
 
 #ifdef HAVE_ONDEMAND
 VAR int			IdleExitTimeout		VALUE(60);
diff --git a/scheduler/main.c b/scheduler/main.c
index 4a66cbcae..3a51e7bea 100644
--- a/scheduler/main.c
+++ b/scheduler/main.c
@@ -72,6 +72,8 @@ static void		service_checkin(void);
 static void		service_checkout(void);
 #endif /* HAVE_ONDEMAND */
 static void		usage(int status) __attribute__((noreturn));
+int			write_pid(void);
+int			remove_pid(void);
 
 
 /*
@@ -676,6 +678,11 @@ main(int  argc,				/* I - Number of command-line args */
     cupsdStartSystemMonitor();
 #endif /* __APPLE__ */
 
+  if (write_pid() == 0) {
+    cupsdLogMessage(CUPSD_LOG_ERROR, "Unable to write pid file");
+    return (1);
+  }
+
  /*
   * Send server-started event...
   */
@@ -1179,10 +1186,41 @@ main(int  argc,				/* I - Number of command-line args */
 
   cupsdStopSelect();
 
+  remove_pid();
+
   return (!stop_scheduler);
 }
 
 
+/* 'write_pid()' - Write PID file.
+   'remove_pid()' - Delete PID file.
+*/
+int
+write_pid()
+{
+  FILE *f;
+  int fd;
+  int pid;
+  if (((fd = open(PidFile, O_RDWR|O_CREAT, 0644)) == -1)
+      || ((f = fdopen(fd, "r+")) == NULL) ) {
+    return 0;
+  }
+  pid = getpid();
+  if (!fprintf(f, "%d\n", pid)) {
+    close(fd);
+    return 0;
+  }
+  fflush(f);
+  close(fd);
+
+  return pid;
+}
+
+int
+remove_pid() {
+  return unlink(PidFile);
+}
+
 /*
  * 'cupsdAddString()' - Copy and add a string to an array.
  */
diff --git a/test/run-stp-tests.sh b/test/run-stp-tests.sh
index 0dd860289..106091805 100755
--- a/test/run-stp-tests.sh
+++ b/test/run-stp-tests.sh
@@ -525,6 +525,7 @@ FontPath $BASE/share/fonts
 DocumentRoot $root/doc
 RequestRoot $BASE/spool
 TempDir $BASE/spool/temp
+PidFile $BASE/cupsd.pid
 AccessLog $BASE/log/access_log
 ErrorLog $BASE/log/error_log
 PageLog $BASE/log/page_log
